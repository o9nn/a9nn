name: Test

on:
  push:
    branches: [ main, master, develop, copilot/** ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test on ${{ matrix.os }} with ${{ matrix.lua }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04]
        lua: [LUAJIT21, LUA51]
    
    env:
      TORCH_LUA_VERSION: ${{ matrix.lua }}
      INSTALL_PREFIX: ${{ github.workspace }}/torch/install
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup cache key
        id: cache-key
        run: |
          echo "openblas-key=${{ runner.os }}-gcc-openblas-v1" >> $GITHUB_OUTPUT
          echo "torch-key=${{ runner.os }}-gcc-${{ matrix.lua }}-torch-v1" >> $GITHUB_OUTPUT
      
      - name: Cache OpenBLAS
        id: cache-openblas
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/OpenBlasInstall
          key: ${{ steps.cache-key.outputs.openblas-key }}
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            gfortran \
            gcc-multilib \
            gfortran-multilib \
            liblapack-dev \
            build-essential \
            curl \
            libreadline-dev \
            git-core \
            libjpeg-dev \
            libpng-dev \
            ncurses-dev \
            imagemagick \
            libzmq3-dev \
            unzip \
            gnuplot
      
      - name: Build OpenBLAS
        if: steps.cache-openblas.outputs.cache-hit != 'true'
        run: |
          cd /tmp
          git clone https://github.com/xianyi/OpenBLAS.git -b master --depth 1
          cd OpenBLAS
          make NO_AFFINITY=1 -j$(nproc)
          make PREFIX=${{ github.workspace }}/OpenBlasInstall install
      
      - name: Cache Torch
        id: cache-torch
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/torch
          key: ${{ steps.cache-key.outputs.torch-key }}
      
      - name: Clone and build Torch
        if: steps.cache-torch.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/torch/distro.git ${{ github.workspace }}/torch --recursive --depth 1
          cd ${{ github.workspace }}/torch
          git submodule update --init --recursive
          mkdir -p build && cd build
          export CMAKE_LIBRARY_PATH=${{ github.workspace }}/OpenBlasInstall/include:${{ github.workspace }}/OpenBlasInstall/lib:$CMAKE_LIBRARY_PATH
          cmake .. \
            -DCMAKE_INSTALL_PREFIX="${{ env.INSTALL_PREFIX }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DWITH_${{ matrix.lua }}=ON
          make -j$(nproc)
          make install
      
      - name: Build a9nn
        run: |
          export LD_LIBRARY_PATH=${{ env.INSTALL_PREFIX }}/lib:$LD_LIBRARY_PATH
          export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
          ${{ env.INSTALL_PREFIX }}/bin/luarocks make rocks/nn-scm-1.rockspec
      
      - name: Run main test suite
        id: main-tests
        continue-on-error: true
        run: |
          export LD_LIBRARY_PATH=${{ env.INSTALL_PREFIX }}/lib:$LD_LIBRARY_PATH
          export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
          TESTLUA=$(which luajit lua | head -n 1)
          echo "Running main test suite with $TESTLUA"
          $TESTLUA -lnn -e "t=nn.test(); if t.errors[1] then os.exit(1) end" 2>&1 | tee test-output.log
      
      - name: Run NNECCO tests
        id: nnecco-tests
        continue-on-error: true
        run: |
          export LD_LIBRARY_PATH=${{ env.INSTALL_PREFIX }}/lib:$LD_LIBRARY_PATH
          export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
          TESTLUA=$(which luajit lua | head -n 1)
          echo "Running NNECCO test suite"
          if [ -f test/test_nnecco.lua ]; then
            $TESTLUA test/test_nnecco.lua 2>&1 | tee test-nnecco-output.log
          else
            echo "NNECCO tests not found, skipping"
          fi
      
      - name: Run Agent-Neuro tests
        id: agent-tests
        continue-on-error: true
        run: |
          export LD_LIBRARY_PATH=${{ env.INSTALL_PREFIX }}/lib:$LD_LIBRARY_PATH
          export PATH=${{ env.INSTALL_PREFIX }}/bin:$PATH
          TESTLUA=$(which luajit lua | head -n 1)
          echo "Running Agent-Neuro test suite"
          if [ -f test/test_agent_neuro.lua ]; then
            $TESTLUA test/test_agent_neuro.lua 2>&1 | tee test-agent-output.log
          else
            echo "Agent-Neuro tests not found, skipping"
          fi
      
      - name: Check test results
        run: |
          echo "Main tests: ${{ steps.main-tests.outcome }}"
          echo "NNECCO tests: ${{ steps.nnecco-tests.outcome }}"
          echo "Agent tests: ${{ steps.agent-tests.outcome }}"
          if [ "${{ steps.main-tests.outcome }}" == "failure" ]; then
            echo "‚ùå Main test suite failed"
            exit 1
          fi
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-logs-${{ matrix.os }}-${{ matrix.lua }}
          path: |
            test-*.log
          retention-days: 30
